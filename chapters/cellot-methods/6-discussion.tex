\section{Discussion}

In this work we propose \textsc{CellOT}, a framework to model single-cell perturbation responses from unpaired treated and untreated cell states using neural optimal transport.
By adequately modeling the nature of the problem through the lens of optimal transport, \textsc{CellOT} determines how perturbations affect cellular properties, reconstructs the most likely trajectory single cells take upon perturbation, and subsequently assists in a better understanding of driving factors of cell fate decision and cellular evasion mechanisms.
\textsc{CellOT} builds on the recent successes of optimal transport applications in single-cell biology \cite{schiebinger2019, lavenant2023}, by introducing a fully parameterized transport map that can be applied to incoming unseen samples.
Previous methods \cite{leygonie2019, yang2019, prasad2022} rely on an unconstrained parameterization of the \emph{primal} optimal transport map. However, the unconstrained nature of these models makes robust optimization challenging and results in reduced performance \cite[Table 1]{makkuva2020}.
Instead, we learn the transformation of unperturbed to perturbed cell states through the \emph{dual} optimal transport problem, parameterized via a pair of neural networks constrained to be convex \cite{makkuva2020}.
These constraints are important inductive biases that facilitate learning and result in a reliable and easy-to-train framework, as evidenced by the consistently strong performance of \textsc{CellOT} on several problems without the need for extensive hyperparameter tuning (see Online Methods).

\textsc{CellOT} infers the highly complex and nonlinear evolution of cell populations in response to perturbations without making strong simplifying assumptions on the nature of these dynamics.
Unlike current approaches comprising autoencoder-based baselines \cite{lopez2018, lotfollahi2019, yang2020}, \textsc{CellOT} does not necessarily rely on learning meaningful low-dimensional embeddings in which perturbations are modeled as linear shifts. % , thus faithfully capturing the heterogeneity of single-cell perturbation responses and accounting for high cell-to-cell variability.
We confirm this advantage through experiments on single-cell responses to different drugs in cancer cell lines obtained with RNA-seq and spatially resolved 4i measurements, where \textsc{CellOT} consistently outperforms (Figure \ref{fig:cellot-main-marginals} and Supplemental Figure \ref{supp_fig:4i_all_results}). Our evaluations went beyond the often-used average treatment effect and correlation analysis across all cells; we analyzed marginals
% UMAPs
and computed MMD scores, a strong measure of how well predicted and observed distributions match.

Using \textsc{CellOT} to perform cell-state-aware drug profiling enables us to quantify perturbation effects as a function of the underlying heterogeneity of the studied system, in our cases a co-culture of two melanoma cell lines with different sensitivities to drug treatments. In doing so, we \textit{sharpen} the response profiles of the measured drugs and reveal cell-state-specific responses of multiple signaling pathway in relation to treatment history of the cell line donor. We find the signaling activity associated to the MEK and PI3k pathways to decouple in cells pre-exposed to MEK inhibitors, a known adaptation mechanism for therapy evasion in melanoma cells \cite{kun2021}. This \textit{pathway rewiring} is associated to alteration in the molecular feedback structure of cells from effectors to receptors \cite{kun2021, turke2012}. Thus, combining \textsc{CellOT} with a larger set of combination treatments, multiplexed imaging, and cellular systems reflective of disease adaptations may help us to elucidate the molecular mechanisms of signaling pathway evolution in the context of cancer therapy. 

The results in Figures \ref{fig:cellot-main-marginals} and \ref{fig:cellot-main-4i-analysis} are based on predictions on cells from the same sample but that were not used for training (i.i.d. setting). The treatment effects can then be analyzed by scrutinizing the learned maps (cf. Figure \ref{fig:cellot-main-4i-analysis}). However, for predicting the treatment effect in practice, it is much more relevant 
We further analyze how well the learned maps generalize beyond samples used for training (o.o.s. setting) and to different sample compositions (o.o.d. setting). In Figure \ref{fig:cellot-main-ood}, we therefore test \textsc{CellOT}'s ability to
%  generalize beyond settings containing cells derived from the same sample. Specifically, we study the challenging out-of-sample setting when 
to predict treatment responses in unseen lupus patients, infer developmental trajectories on stem cells of lower potency, and translate innate immune responses across patients.
In all cases, \textsc{CellOT}'s accuracy and precision are superior to current state-of-the-art methods (Figure \ref{fig:cellot-main-ood}).
 Moreover, the predicted cell states after perturbation are still very close to the actually observed cell states.
 We consider these results as particularly promising, as it illustrates that accurate o.o.s. and o.o.d. predictions are indeed possible.

The ability to make predictions out-of-distribution, such as on unseen patients, is, however, only feasible if a) similar samples have been observed in the unperturbed setting, and b) the training set contains cases that are similar not only in their unperturbed state but also their perturbation response.
An analysis of glioblastoma patients treated with Panobinostat \cite{zhao2021} (see Supplemental Figure \ref{supp_fig:gbm_patients_iid_ood}a-c) indeed confirms this restriction:
\textsc{CellOT} and the baselines are able to predict treatment outcomes for those patients that are similar to other patients in both unperturbed state as well as perturbation effect (see Supplemental Figure \ref{supp_fig:gbm_patients_iid_ood}f), but fail to capture perturbation effects for patients that exhibit unique responses (see Supplemental Figure \ref{supp_fig:gbm_patients_iid_ood}g).
This limitation is important to consider when applying \textsc{CellOT} in o.o.d. settings. To overcome such problems, 
larger cohorts, additional meta-information, and methodological extensions are required. \citet{bunne2022} partially address this issue by deriving a neural optimal transport scheme that can be conditioned on a context, e.g., patient meta-data, when predicting perturbation responses.

We also observe that the predictive performance for \textsc{CellOT} drops when perturbations are too strong, i.e., the cell distributions before and after perturbations are very different (see Figure \ref{fig:cellot-main-ood}j); a similar drop is observed for the other methods (see Supplemental Figure \ref{supp_fig:statefate_days_all_methods}).
The principle underlying the optimal transport theory is ideally suited for acute cellular perturbations during which single cells do not redistribute entirely and randomly in multidimensional measurement space, but typically only in a few dimensions, such that the overall correlation structure is preserved. While this modeling hypothesis is satisfied when perturbation responses are observed via regularly and frequently sampled snapshots, molecular transitions cannot be reconstructed when perturbation responses have progressed too far. For particularly strong or complicated perturbations, cellular multiplex profiles might change too drastically, violating OT assumptions and making it challenging to reconstruct the alignments between unperturbed and perturbed populations based on the \emph{minimal effort} principle.
In such settings, additional information is likely needed, for instance, a model of the underlying biology or models that integrate observations of multiple smaller time steps. 

Despite the stochastic nature of cell fate decisions and the fact that cellular dynamics are intrinsically noisy \cite{wilkinson2009}, \textsc{CellOT} models cell responses as deterministic trajectories.
Approaches treating cell fate decisions as probabilistic events have previously allowed estimation of the full dynamical model to a greater extent than their deterministic counterparts \cite{bergen2020}.
By connecting OT and stochastic difference equations, recent work \cite{bunne2022, somnath2023} can build up on \textsc{CellOT} to account for biological heteroscedasticity,
% affecting cellular perturbation responses on a finer level
at the cost of added model complexity and other simplifying assumptions.

Despite having provided a proof-of-concept of the capacity of \textsc{CellOT} to model various chemical perturbations for different data modalities through an in-depth analysis of the nature of the learned mapping as well as a demonstration of its versatility in a broad class of applications, \textsc{CellOT}'s generalization capacity has been evaluated on relatively small datasets. Crucially, large cohorts comprised of patients with different molecular profiles, such as cancer patients with various underlying genetics, could result in strongly heterogeneous treatment responses.
It is evident that approaches addressing these challenges could readily exploit the upcoming availability of large-scale patient cohort studies.
The use of neural optimal transport to learn single-cell drug responses makes thus for an exciting avenue for future work,
including its use to improve our understanding of cell therapies, study drug responses from patient samples, and better account for cell-to-cell variability in large-scale drug design efforts.
